<!--
 * @Description:
 * @Author: 姚泽毅
 * @Date: 2022-05-19 17:20:12
 * @LastEditTime: 2024-10-17 14:55:32
-->
<!DOCTYPE html>

<html lang="zh_CN">

<head runat="server">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <!-- 窗口小图标 -->
  <link href="../Image/Teacher/index/urlsystemIcon.ico" rel="shortcut icon" />
  <link href="../CSS/GlobalStyle.css" rel="stylesheet" />
  <link href="../ComCss/tqstandard.css" rel="stylesheet" />
  <link href="../CSS/Teacher/PaperPrint.css" rel="stylesheet" />
  <!-- 打印的样式-->
  <style media="print">
    .btn-print-paper {
      display: none;
    }
  </style>
  <style type="text/css">
    .Ques-td {
      border: solid 1px;
    }

    /*
    .page-table-break table {
      page-break-inside: avoid;
    } */

    .tq-p {
      line-height: 32px !important;
      font-size: 20px;
    }

    .tq-p img,
    .active-img p img {
      /* margin-right：8px 改成 padding-right 会解决异常图片分页问题 */
      padding-right: 8px;
    }

    /*.page-img-break img{
            margin-right:5px;
        }

        .page-img-break td {
            overflow:hidden;
        }*/

    .inlinBlock {
      display: inline-block;
      padding-right: 20px;
    }

    .znbkblank {
      height: 28px !important;
    }

    .text-paper-kind-name {
      font-size: 20px;
      width: 880px;
      margin: 0 auto;
    }

    .k0_classType>.tq-p {
      line-height: 18px !important;
    }

    .k0_classType>.tq-p>span {
      line-height: 100% !important;
    }

    .active-show-single-column5 {
      width: 20%;
      float: left;
      text-align: center;
    }

    .zwjx>p {
      line-height: 32px;
    }

    .lh32 {
      line-height: 32px;
    }

    /* 紧凑版 */
    .small-size {
      font-size: 18px;
      line-height: 28px;
    }

    .small-size .lh32 {
      line-height: 28px;
    }

    .small-size .text-paper-name {
      font-size: 30px;
    }

    .small-size .text-paper-kind-name {
      font-size: 18px;
    }

    .small-size .tq-p {
      font-size: 18px;
      line-height: 28px !important;
    }

    .small-size .zwjx>p {
      line-height: 28px;
    }

    .small-size .text-item-title-index {
      font-size: 18px;
    }
    .appDownloadQRCode {
      width: 80%;
      float: right;
    }
    .appDownload {
      margin-left: 10px;
    }
  </style>
  <title>试卷打印</title>
</head>

<body>
  <script src="./../ComJS/angular.min.js"></script>
  <script src="./../ComJS/angular-sanitize.min.js"></script>
  <script src="./../ComJS/jquery.min.js"></script>
  <script src="./../ComJS/json2.js"></script>
  <script src="./../ComJS/znbkxx.ajaxWithOutToken.js"></script>
  <form id="form1" runat="server"></form>
  <div ng-app="app">
    <div ng-controller="TeacherPaperPrint" ng-init="InitPage()">
      <div class="sec-teacher-and-student-paper hide-style" ng-class="{'small-size':smallSize==1}"
        ng-show="PaperType == 0 || PaperType == 1">
        <img ng-if="PaperType == 1" src="../img/appDownloadQRCode.png" alt="下载APP" title=""
          style="display: block; width: 130px; float: left; margin-left: 45px; margin-top: 10px;">
        <div ng-class="{'appDownloadQRCode': PaperType == 1}">
          <div ng-if="!ToC" class="text-paper-name">
            <span ng-bind="PaperModel.SetName" ng-if="PaperModel.Layer!=5"></span>
            <span ng-show="PaperModel.SetName.length >0" ng-if="PaperModel.Layer!=5">（</span>
            <span ng-bind="PaperModel.PaperName"></span>
            <span ng-show="PaperModel.SetName.length >0" ng-if="PaperModel.Layer!=5">）</span>
          </div>
          <!-- ToC版本的卷名(toc版本ToC为1，且没有SetName) -->
          <div ng-if="ToC" class="text-paper-name">
            <span ng-bind="PaperModel.PaperName"></span>
          </div>
          <!-- <div class="sec-paper-config-info" ng-class="{'appDownloadQRCode': PaperType == 1}">
            <span ng-bind="'共' + PaperModel.TypeList.length + '道大题'" style="width: 30%">共6道大题</span>
            <span ng-bind="'满分：'+ PaperModel.FullScore + '分'" style="width: 30%"></span>
            <span ng-bind="'考试时间：'+ PaperModel.AnswerLength + '分钟'" style="width: 40%"></span>
            <img ng-if="PaperType == 1" src="../img/appDownloadQRCode.png" alt="下载APP" title=""
                    style="display: block; width: 150px; margin-left: 10px;">
          </div> -->
          <div class="sec-paper-config-info" ng-class="{'appDownload': PaperType == 1}">
            <span ng-bind="'共' + PaperModel.TypeList.length + '道大题'" style="width: 30%">共6道大题</span>
            <span ng-bind="'满分：'+ PaperModel.FullScore + '分'" style="width: 30%"></span>
            <span ng-bind="'考试时间：'+ PaperModel.AnswerLength + '分钟'" style="width: 40%"></span>
          </div>
        </div>
        <div class="dv-paper-content">
          <div ng-repeat="typeItem in PaperModel.TypeList" style="float: left; width: 100%"
            ng-init="firstIndex = $index">
            <!-- 展示题型导语 -->
            <div ng-if="guidanceInfo.IsCustomized" ng-bind-html="(typeItem.TypeGuidance) | to_trusted">
            </div>
            <div class="typeGuidance" ng-if="!guidanceInfo.IsCustomized">
              <span ng-bind-html="(NumberFormat(firstIndex+1) + '、') | to_trusted" class="label"></span>
              <span ng-bind-html="(removeP(typeItem.TypeGuidance)) | to_trusted"></span>
            </div>
            <!-- 第二层循环小题循环 -->
            <div ng-repeat="quesItem in typeItem.QuesDetailList" class="QuesListBox" ng-init="secondIndex = $index">
              <!-- 试题导语-篇章之前(Position:0) -->
              <div ng-if="quesItem.QuesGuidanceObj.Position===0"
                ng-bind-html="(quesItem.QuesGuidanceObj.QuesGuidance) | to_trusted">
              </div>
              <!-- 篇章序号（A,B,C...） -->
              <span class="text-item-title-index"
                ng-bind="'(' + NumberToChar(secondIndex,firstIndex,typeItem.QuesDetailList.length) + ')'"
                ng-show="ShowCharIndex(firstIndex)"></span>
              <div class="active-p active-img lh32" style="margin-bottom: 5px; word-spacing: 2px;"
                ng-class="{'page-table-break':IsAddPageBreakInside(quesItem.QuesBody) == true}"
                ng-bind-html="quesItem.QuesBody | to_trusted"
                ng-show="quesItem.QuesBody.length && typeItem.TypeNo != 'U'"></div>
              <!-- 试题导语-篇章之后，小题之前(Position:1) -->
              <div ng-if="quesItem.QuesGuidanceObj.Position===1"
                ng-bind-html="(quesItem.QuesGuidanceObj.QuesGuidance) | to_trusted">
              </div>
              <ul style="float: left; width: 100%">
                <!-- 第三层循环 -->
                <li ng-repeat="(cIndex,childList) in quesItem.ChildList" style="width: 100%; float: left"
                  ng-init="childIndex = $index">
                  <div ng-bind="childList.ChildSectionName" style="font-weight: bold"
                    ng-show="typeItem.TypeNo == 'H' && typeItem.GenreID == '78'"></div>
                  <div ng-bind="childList.ChildDisplay" ng-show="typeItem.TypeNo == 'H' && typeItem.GenreID == '78'">
                  </div>
                  <span ng-bind="childList.ItemList[0].SortIndex+'.'" class="lh32" style="
                                        float: left;
                                        margin-right: 5px;
                                        width: 35px;
                                    " ng-show="childList.SortIndexType == 0"
                    ng-style="{'visibility':typeItem.TypeNo == 'H'&& typeItem.GenreID == 78 && childIndex == quesItem.ChildList.length - 1?'hidden':'visible'}"></span>
                  <!-- 3.11题型样式兼容 -->
                  <div class="childListBox" style="float: left"
                    ng-style="{'width':(typeItem.TypeNo == 'm' && (typeItem.GenreID == '17' || typeItem.GenreID == '15'))||(typeItem.TypeNo == 'N' && typeItem.GenreID == '23')?'100%':'840px'}">
                    <ul class="body-ul">
                      <li>
                        <div>
                          <div style="width: 100%; overflow: hidden">
                            <div class="dv-special-item-border" ng-show="isShowAnswerMatching(quesItem,cIndex)">
                              <ul class="body-ul" style="margin: 10px; width: 98%; float: none">
                                <!--已经答题的循环-->
                                <li ng-repeat="(optionIndex, optionList) in childList.ChildOptionList"
                                  ng-class="{'active-show-single-column1': CountInLine(childList, typeItem.TypeNo, typeItem.GenreID) == 4, 'active-show-single-column2': CountInLine(childList, typeItem.TypeNo, typeItem.GenreID) == 2, 'active-show-single-column4': CountInLine(childList, typeItem.TypeNo, typeItem.GenreID) == 1, 'active-show-single-column5': CountInLine(childList, typeItem.TypeNo, typeItem.GenreID) == 5, 'dv-alignCenter':(typeItem.TypeNo == 'm' && typeItem.GenreID == '15')}">
                                  <span class="lh32" class="lh32" ng-bind="optionList.OptionIndex + '. '"></span>
                                  <span ng-bind-html="optionList.Option | to_trusted" class="lh32"></span>
                                </li>
                                <div style="clear: both"></div>
                              </ul>
                            </div>
                          </div>
                          <div
                            ng-class="{'active-p':(typeItem.TypeNo == 'f' && (typeItem.GenreID == 34 || typeItem.GenreID == 35)) || (typeItem.TypeNo == 'N' && (typeItem.GenreID == 23 || typeItem.GenreID == 96)) || (typeItem.TypeNo == 'm' && (typeItem.GenreID == 15 || typeItem.GenreID == 17)),'active-text-indent-zero':JustiyVacabularyBlank(firstIndex,secondIndex) == true}"
                            ng-bind-html="childList.ChildAsk | to_trusted"
                            ng-show="IsShowSubChildAsk(childList.ChildAsk)"
                            style="text-align: left; word-spacing: 2px;">
                          </div>
                          <div style="width: 100%; overflow: hidden">
                            <div class="dv-special-item-border"
                              ng-show="typeItem.TypeNo == 'm'&&typeItem.GenreID == '17'">
                              <ul style="margin: 10px; width: 98%">
                                <!--已经答题的循环-->
                                <li ng-repeat="(optionIndex, optionList) in childList.ChildOptionList"
                                  ng-class="{'active-show-single-column1': CountInLine(childList, typeItem.TypeNo, typeItem.GenreID) == 4, 'active-show-single-column2': CountInLine(childList, typeItem.TypeNo, typeItem.GenreID) == 2, 'active-show-single-column4': CountInLine(childList, typeItem.TypeNo, typeItem.GenreID) == 1, 'active-show-single-column5': CountInLine(childList, typeItem.TypeNo, typeItem.GenreID) == 5, 'dv-alignCenter':(typeItem.TypeNo == 'm' && typeItem.GenreID == '15')}">
                                  <span class="lh32" ng-bind="optionList.OptionIndex + '. '"></span>
                                  <span ng-bind-html="optionList.Option | to_trusted" class="lh32"></span>
                                </li>
                                <div style="clear: both"></div>
                              </ul>
                            </div>
                          </div>
                          <ul class="body-ul" ng-show="typeItem.TypeNo != 'm' && typeItem.TypeNo != 'P'">
                            <!--已经答题的循环-->
                            <li ng-repeat="(optionIndex, optionList) in childList.ChildOptionList"
                              style="margin-bottom: 5px"
                              ng-class="{'active-show-single-column1': CountInLine(childList, typeItem.TypeNo, typeItem.GenreID) == 4, 'active-show-single-column2': CountInLine(childList, typeItem.TypeNo, typeItem.GenreID) == 2, 'active-show-single-column4': CountInLine(childList, typeItem.TypeNo, typeItem.GenreID) == 1, 'active-show-single-column5': CountInLine(childList, typeItem.TypeNo, typeItem.GenreID) == 5,'active-show-single-img': CountInLine(childList, typeItem.TypeNo, typeItem.GenreID) == -1}">
                              <span class="lh32"
                                ng-class="{'dv-float': CountInLine(childList, typeItem.TypeNo, typeItem.GenreID) == -1}"
                                ng-bind="optionList.OptionIndex + '. '"></span>
                              <span ng-bind-html="optionList.Option | del_blank" class="lh32"></span>
                            </li>
                          </ul>
                        </div>
                      </li>
                    </ul>
                  </div>
                </li>
              </ul>
              <div style="clear: both"></div>
              <!-- 试题导语-小题之后(Position:2) -->
              <div ng-if="quesItem.QuesGuidanceObj.Position===2"
                ng-bind-html="(quesItem.QuesGuidanceObj.QuesGuidance) | to_trusted">
              </div>
              <div class="ckda" ng-show="PaperType == 0" style="width: 100%; border-top: 1px solid transparent">
                <div class="lineBlock col_green widJx" ng-bind="'【参考答案】'"></div>
                <ul class="lh32" style="
                      width: 760px;
                      float: left;
                      margin-left: -13px;
                    ">
                  <li ng-repeat="childList in quesItem.ChildList"
                    style="display: inline-block; /*; margin-left: 20px; */">
                    <ul style="display: inline-block" ng-show="childList.SortIndexType == 1">
                      <li style="list-style: none">
                        <ul style="
                              display: inline-block;
                              margin: 0px;
                              padding: 0px;
                            ">
                          <li ng-repeat="(itemIndex, item) in childList.ItemList" class="lineBlock"
                            ng-style="{'width':PaperModel.TypeList[firstIndex].TypeNo == 'X' ? '750px':'auto', 'margin-left': '20px'}"
                            style="display: inline-block"
                            ng-class="{'wd12': GetOrderNumberWidth(childList.ItemList) == 1 && PaperModel.TypeList[firstIndex].TypeNo != 'X' ,'wd20':GetOrderNumberWidth(childList.ItemList) == 2 && PaperModel.TypeList[firstIndex].TypeNo != 'X','wd28':GetOrderNumberWidth(childList.ItemList) == 3 && PaperModel.TypeList[firstIndex].TypeNo != 'X'}"
                            ng-show="quesItem.ChildList.length > 1 || childList.ItemList.length > 1 ">
                            <span style="
                                  text-align: left;
                                  display: inline-block;
                                  vertical-align: top;
                                " ng-bind="item.SortIndex + '.'"></span>
                            <span style="max-width: 700px; display: inline-block"
                              ng-bind-html="item.ItemAnswer | del_delimiter"></span>
                          </li>
                          <li ng-repeat="(itemIndex, item) in childList.ItemList" class="lineBlock"
                            ng-bind-html="isHaveAnswer(item.ItemAnswer) | del_delimiter"
                            style="display: inline-block; margin-left: 20px"
                            ng-show="quesItem.ChildList.length == 1 && childList.ItemList.length == 1 ">
                          </li>
                        </ul>
                      </li>
                    </ul>
                    <!-- 阅读综合SortIndexType == 0的显示样式 -->
                    <ul ng-show="childList.SortIndexType == 0" style="
                          display: inline-block;
                          width: 750px;
                          overflow: hidden;
                          margin-left: 20px;
                        "
                      ng-style="{'width':(typeItem.TypeNo == 'P' || typeItem.TypeNo == 'F' || typeItem.TypeNo == 'E' || typeItem.TypeNo == 'D' || typeItem.TypeNo == 'C' || (typeItem.TypeNo == 'N' && typeItem.GenreID == '20'))?'auto':'750px'}">
                      <!-- childList.SortIndexType == 2 -->
                      <li class="dv-flex-row-start" style="list-style: none; line-height: 24px">
                        <div style="
                              text-align: left;
                              display: inline-block;
                              vertical-align: top;
                            " ng-show="quesItem.ChildList.length > 1" ng-bind="childList.ItemList[0].SortIndex + '.'">
                        </div>
                        <span class="zwjx" style="max-width: 720px; display: inline-block"
                          ng-bind-html="ReplaceSubChildAnswer(childList.ChildAnswer) | to_trusted"></span>
                      </li>
                    </ul>
                  </li>
                </ul>
                <div style="clear: both"></div>
              </div>
              <div class="ckda" ng-show="PaperType == 0" style="width: 100%; border-top: 1px solid transparent">
                <div class="lineBlock col_green widJx" ng-bind="'【答案解析】'"></div>
                <ul class="lh32" style="
                      display: block;
                      width: 880px;
                      float: left;
                      margin-left: -13px;
                    " ng-show="IsAllnoData(quesItem.ChildList)">
                  <li ng-repeat="childList in quesItem.ChildList" style="display: block; /*; margin-left: 20px; */">
                    <ul style="display: block" ng-show="childList.SortIndexType == 1">
                      <li style="list-style: none">
                        <ul style="display: block; margin: 0px; padding: 0px">
                          <li ng-repeat="(itemIndex, item) in childList.ItemList" class="lineBlock"
                            ng-style="{'width':PaperModel.TypeList[firstIndex].TypeNo == 'X' ? '750px':'auto', 'margin-left': '20px'}"
                            style="display: block; float: left"
                            ng-class="{'wd12': GetOrderNumberWidth(childList.ItemList) == 1 && PaperModel.TypeList[firstIndex].TypeNo != 'X' ,'wd20':GetOrderNumberWidth(childList.ItemList) == 2 && PaperModel.TypeList[firstIndex].TypeNo != 'X','wd28':GetOrderNumberWidth(childList.ItemList) == 3 && PaperModel.TypeList[firstIndex].TypeNo != 'X'}"
                            ng-show="quesItem.ChildList.length > 1 || childList.ItemList.length > 1 ">
                            <span style="
                                  text-align: left;
                                  display: block;
                                  float: left;
                                " ng-bind="item.SortIndex + '.'"></span>
                            <span style="
                                  max-width: 800px;
                                  display: block;
                                  float: left;
                                " ng-bind-html="item.ItemAnalysis || '...略'"></span>
                          </li>
                          <li ng-repeat="(itemIndex, item) in childList.ItemList" class="lineBlock"
                            ng-bind-html="isHaveAnswer(item.ItemAnswer) | del_delimiter"
                            style="display: block; margin-left: 20px"
                            ng-show="quesItem.ChildList.length == 1 && childList.ItemList.length == 1 ">
                          </li>
                        </ul>
                      </li>
                    </ul>
                    <!-- 阅读综合SortIndexType == 0的显示样式 -->
                    <ul ng-show="childList.SortIndexType == 0" style="
                          display: block;
                          width: 880px;
                          overflow: hidden;
                          margin-left: 14px;
                        "
                      ng-style="{'width':(typeItem.TypeNo == 'P' || typeItem.TypeNo == 'F' || typeItem.TypeNo == 'E' || typeItem.TypeNo == 'D' || typeItem.TypeNo == 'C' || (typeItem.TypeNo == 'N' && typeItem.GenreID == '20'))?'auto':'860px'}">
                      <li class="dv-flex-row-start" style="list-style: none; line-height: 24px">
                        <span class="lh32" style="
                              text-align: left;
                              display: block;
                              float: left;
                            " ng-show="quesItem.ChildList.length > 1"
                          ng-bind="childList.ItemList[0].SortIndex + '.'"></span>
                        <span class="lh32" style="
                              max-width: 880px;
                              display: block;
                            " ng-bind-html="childList.ChildAnalysis || '...略'"></span>
                      </li>
                    </ul>
                  </li>
                </ul>
                <div class="lh32" style="
                      display: block;
                      width: 750px;
                      float: left;
                      margin-left: 6px;
                    " ng-hide="IsAllnoData(quesItem.ChildList)" ng-bind="'...略'"></div>
                <div style="clear: both"></div>
              </div>
              <div style="
                    float: left;
                    width: 100%;
                    height: 1px;
                    border-bottom: dashed 1px #fff;
                    margin-top: 8px;
                    margin-bottom: 8px;
                  "
                ng-show="ShowSortIndex(firstIndex,secondIndex) == false && secondIndex != typeItem.quesItem.length - 1">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
<script type="text/javascript">
  //获取url参数
  var getUrlInfo = function (queryName) {
    var query = decodeURI(window.location.search.substring(1));
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');
      if (pair[0] == queryName) {
        return pair[1];
      }
    }
    return '';
  };
  var globalConst = (function (cons) {
    cons.ID = getUrlInfo("ID");
    cons.PaperID = getUrlInfo('paperID');
    // cons.GlobalGrade = getUrlInfo('globalGrade');
    cons.StageNo = getUrlInfo('stageNo');
    cons.TempletId = getUrlInfo('templetID');
    cons.UserID = getUrlInfo('userID') || getUrlInfo('UserID') || '';
    cons.Token = '';
    cons.PaperType = getUrlInfo('paperType');
    cons.smallSize = getUrlInfo('smallSize');
    cons.SetID = getUrlInfo('setID');
    cons.ProvinceID = getUrlInfo('provinceID');
    cons.CityID = getUrlInfo('cityID');
    cons.ToC = getUrlInfo('ToC') || '';
    console.log(cons, 'cons')
    return cons;
  })(globalConst || {});

  var app = angular.module('app', ['ngSanitize']);

  //html格式化
  app.filter('to_trusted', [
    '$sce',
    function ($sce) {
      return function (text) {
        return $sce.trustAsHtml(text);
      };
    },
  ]);

  //处理答案中分割符
  app.filter('del_delimiter', [
    '$sce',
    function ($sce) {
      return function (text) {
        if (text != undefined) {
          text = text.replace(/\$、/g, '、');
          text = text.replace(/\$\|/g, '和');
          text = text.replace(/\$\//g, '或');
          return $sce.trustAsHtml(text);
        }
      };
    },
  ]);

  //处理选项中字符串前后空格问题
  app.filter('del_blank', [
    '$sce',
    function ($sce) {
      return function (text) {
        if (text != undefined) {
          text = text.trim();
          return $sce.trustAsHtml(text);
        }
      };
    },
  ]);

  app.controller('TeacherPaperPrint', [
    '$scope',
    '$timeout',
    '$interval',
    function ($scope, $timeout, $interval) {
      $scope.InitPage = function () {
        $scope.smallSize = globalConst.smallSize;
        $scope.headerParams = {};
        $scope.ToC = globalConst.ToC;
        console.log($scope)
        if (!$scope.ToC) {
          // 如果是非ToC版本
          globalConst.UserID = 'znbkxx';
          globalConst.Token = 'znbkxx';
        }
        if (globalConst.Token == 'znbkxx') {
          $scope.headerParams = {
            AppKey: 'DUf4E6HtcpCy',
          };
        }
        initBiz();
        initData();
      };

      var initBiz = function () {
        window.status = '';
        // 导语
        this.getTempleAndGuidanceInfo = function () {
          var data = {};
          var url = '';
          if (globalConst.ID) {
            url = 'api/ExternalPaper/GetTempleGuidanceInfo?ID=' + globalConst.ID;
          } else {
            console.log(globalConst.StageNo)
            url =
              'api/Guidance/TempleGuidanceInfo?UserID=123&StageNo=' +
              globalConst.StageNo +
              '&TempletID=' +
              globalConst.TempletId +
              '&Token=123&PaperID=' +
              globalConst.PaperID +
              '&SetID=' +
              globalConst.SetID +
              '&ProvinceID=' +
              globalConst.ProvinceID +
              '&CityID=' +
              globalConst.CityID;
          }
          znbkxx.get(
            url,
            false,
            {},
            function (res) {
              if (res.Code == '10003') {
                //用户未登录或掉线
                console.log('用户未登录或掉线');
              } else {
                if (res.Code == 1) {
                  data = res.Data;
                } else {
                  console.log('获取模板的导语信息失败！');
                }
              }
            },
            function (err) {
              console.log('获取模板的导语信息失败！');
            }
          );
          return data;
        };

        // toC版本导语
        this.getTempleAndGuidanceInfoToC = function () {
          var data = {};
          var url = '';
          url =
            'api/Paper/GetTempletGuidance?UserID=' +
            globalConst.UserID +
            '&StageNo=' +
            globalConst.StageNo +
            '&TempletID=' +
            globalConst.TempletId +
            '&Token=123&PaperID=' +
            globalConst.PaperID +
            '&SetID=' +
            globalConst.SetID +
            '&ProvinceID=' +
            globalConst.ProvinceID +
            '&CityID=' +
            globalConst.CityID;
          znbkxx.get(
            url,
            false,
            {},
            function (res) {
              if (res.Code == '10003') {
                //用户未登录或掉线
                console.log('用户未登录或掉线');
              } else {
                if (res.Code == 1) {
                  data = res.Data;
                } else {
                  console.log('获取toc模板的导语信息失败！');
                }
              }
            },
            function (err) {
              console.log('获取toc模板的导语信息失败！');
            }
          );
          return data;
        };

        // 获取试卷信息
        this.getPaperQuesInfo = function () {
          // 如果有ID那么走叶炎鑫他们导出
          var url = '';
          if (globalConst.ID) {
            url = 'api/ExternalPaper/GetExternalPaperInfo?UserID=&Token=&ID=' + globalConst.ID;
          } else {
            url =
              'api/Paper/GetPaperInfo?UserID=123&PaperID=' +
              globalConst.PaperID +
              '&Token=123&SetID=' +
              globalConst.SetID +
              '&IsExported=true';
          }
          znbkxx.get(
            url,
            true,
            {},
            function (res) {
              if (res.Code == '10003') {
                //用户未登录或掉线
                console.log('用户未登录或掉线');
              } else {
                if (res.Code == 1) {
                  $scope.funInitData(res)
                } else {
                  console.log('获取试卷失败！');
                }
              }
            },
            function (err) {
              console.log('获取试卷失败！');
            }
          );

        };
        // toC版本获取试卷信息
        this.getPaperQuesInfoToC = function () {
          var url = '';
          url =
            'api/Paper/GetPaperInfo?UserID=' + globalConst.UserID + '&PaperID=' +
            globalConst.PaperID +
            '&Token=123&SetID=' +
            globalConst.SetID +
            '&IsExported=true';
          znbkxx.get(
            url,
            true,
            {},
            function (res) {
              if (res.Code == '10003') {
                //用户未登录或掉线
                console.log('用户未登录或掉线');
              } else {
                if (res.Code == 1) {
                  $scope.funInitData(res)
                } else {
                  console.log('获取试卷失败！');
                }
              }
            },
            function (err) {
              console.log('获取试卷失败！');
            }
          );

        };
      };
      // 处理数据
      $scope.funInitData = function (res) {
        $scope.$apply(function () {
          //获取导语信息
          if (!$scope.ToC) {
            // 中学导出
            $scope.guidanceInfo = getTempleAndGuidanceInfo();
          } else {
            // toc版本中学导出，此时ToC传1
            $scope.guidanceInfo = getTempleAndGuidanceInfoToC();
          }
          $scope.StageNo = $scope.guidanceInfo.StageNo;
          // 将题型导语和试题导语附加到TypeList上用于展示
          res.Data.TypeList.forEach(function (typeItem, typeIndex) {
            typeItem.TypeGuidance = $scope.guidanceInfo.TypeList[typeIndex].TypeGuidance
            typeItem.QuesDetailList.forEach(function (quesItem, quesIndex) {
              quesItem.QuesGuidanceObj = $scope.guidanceInfo.TypeList[typeIndex].QuesList[quesIndex]
            })
          })
          $scope.PaperModel = res.Data;
          $('.hide-style').show();
          window.status = 'completed';
        });
      };
      var initData = function () {
        $scope.CurrentIndex = 0;
        $scope.PaperType = globalConst.PaperType;
        //获取试卷信息
        if (!$scope.ToC) {
          // 中学导出
          getPaperQuesInfo();
        } else {
          // toc版本中学导出，此时ToC传1
          getPaperQuesInfoToC();
        }
      };

      $scope.BtnPrintPaper = function () {
        window.print();
      };

      $scope.NumberToChar = function (number, firstIndex, quesLength) {
        var result = 65;
        if ($scope.guidanceInfo.TypeList[firstIndex].TypeMergeFlag == 1) {
          if ($scope.guidanceInfo.TypeList[firstIndex - 1].TypeMergeFlag == 1) {
            // 如果连着两题是跨题型的（序号跨题型增加）
            var tempTypeMergeIndex = 0;//代表跨题型序号
            $scope.PaperModel.TypeList.forEach(function (item, index) {
              // 目前索引之前到每段连续索引开始时的索引之间所有的连续题号的和
              if (index >= firstIndex || $scope.startTypeMergeIndex > index || $scope.guidanceInfo.TypeList[index].TypeMergeFlag != 1) return
              tempTypeMergeIndex += item.QuesDetailList.length;//加上上一段的题目长度
            })
            result += tempTypeMergeIndex;
            console.log($scope.startTypeMergeIndex, tempTypeMergeIndex, result)
          } else {
            $scope.startTypeMergeIndex = firstIndex;//每段连续索引开始时的索引
          }
        }
        GuidanceAudioPath = parseInt(
          $scope.guidanceInfo.TypeList[firstIndex].GuidanceAudioPath
        );
        if (GuidanceAudioPath >= 0) {
          result += number + GuidanceAudioPath;
        } else {
          result += number;
        }
        return String.fromCharCode(result);
      };

      // 去除p标签
      $scope.removeP = function (str) {
        return str.slice(3).slice(0, -4)
      }

      // 兼容题型
      $scope.isShowAnswerMatching = function (quesInfo, cIndex) {
        // console.log(quesInfo, cIndex)
        if (quesInfo.TypeNo == 'm' && quesInfo.GenreID != 17) {
          if (quesInfo.GenreID == '16' && quesInfo.TypeNo == 'm' && cIndex > 0 && quesInfo.SpecialFeatureCodes == "25") {
            // 兼容对话匹配 2024/6/26
            return false
          } else if (quesInfo.GenreID == '91' && quesInfo.TypeNo == 'm' && cIndex > 0) {
            // 兼容中文释义匹配 2024/6/26
            return false
          } else if (quesInfo.GenreID == '87' && quesInfo.TypeNo == 'm' && cIndex > 0) {
            // 兼容英文释义匹配 2024/6/26
            return false
          } else if (quesInfo.GenreID == '15' && quesInfo.TypeNo == 'm' && cIndex > 0 && quesInfo.SpecialFeatureCodes == "1|47") {
            // 兼容词汇匹配 2024/6/26
            return false
          } else {
            return true
          }
        } else {
          return false;
        }
      },

        //函数：是否显示阅读理解、完形选择的试题编号
        $scope.ShowCharIndex = function (index) {
          var result = false;
          if (
            ($scope.PaperModel.TypeList[index].TypeNo == 'C' ||
              $scope.PaperModel.TypeList[index].TypeNo == 'D' ||
              $scope.PaperModel.TypeList[index].TypeNo == 'm' ||
              ($scope.PaperModel.TypeList[index].TypeNo == 'N' &&
                $scope.PaperModel.TypeList[index].GenreID == '23') ||
              $scope.PaperModel.TypeList[index].TypeNo == 'X' ||
              $scope.PaperModel.TypeList[index].TypeNo == 'b' ||
              $scope.PaperModel.TypeList[index].TypeNo == 'Q' ||
              $scope.PaperModel.TypeList[index].TypeNo == 'S' ||
              $scope.PaperModel.TypeList[index].TypeNo == 'k') &&
            ($scope.PaperModel.TypeList[index].QuesList.length > 1 || $scope.guidanceInfo.TypeList[index].TypeMergeFlag == 1)
          )
            result = true;
          return result;
        };

      //函数：是否显示序号
      $scope.ShowSortIndex = function (index, quesIndex) {
        var result = true;
        if (
          ($scope.PaperModel.TypeList[index].TypeNo == 'N' &&
            $scope.PaperModel.TypeList[index].GenreID == '20') ||
          $scope.PaperModel.TypeList[index].TypeNo == 'S' ||
          $scope.PaperModel.TypeList[index].TypeNo == 'Q'
        ) {
          if (
            $scope.PaperModel.TypeList[index].QuesDetailList[quesIndex]
              .SortNum >
            $scope.PaperModel.TypeList[index].QuesDetailList[quesIndex]
              .ChildList.length
          ) {
            result = false;
          } else {
            result = true;
          }
        } else if (
          $scope.PaperModel.TypeList[index].TypeNo == 'k' ||
          $scope.PaperModel.TypeList[index].TypeNo == 'X' ||
          $scope.PaperModel.TypeList[index].TypeNo == 'x'
        ) {
          result = false;
        } else if (
          $scope.PaperModel.TypeList[index].TypeNo == 'm' ||
          $scope.PaperModel.TypeList[index].TypeNo == 'N' ||
          $scope.PaperModel.TypeList[index].TypeNo == 'U' ||
          $scope.PaperModel.TypeList[index].TypeNo == 'b'
        ) {
          result = false;
        }
        return result;
      };

      //函数：选词填空题处理
      $scope.JustiyVacabularyBlank = function (index, quesIndex) {
        var result;
        if (
          $scope.PaperModel.TypeList[index].TypeNo == 'N' &&
          $scope.PaperModel.TypeList[index].GenreID == '20'
        ) {
          if (
            $scope.PaperModel.TypeList[index].QuesDetailList[quesIndex]
              .SortNum >
            $scope.PaperModel.TypeList[index].QuesDetailList[quesIndex]
              .ChildList.length
          ) {
            result = false;
          } else {
            result = true;
          }
        }
        return result;
      };

      //计算一行显示五个
      $scope.CountInLine = function (subChild, typeNo, genreId) {
        var result = 1;
        if (
          (subChild.TKAnswerType == 1 || subChild.TKAnswerType == 16 || subChild.TKAnswerType == 32) && subChild.ChildOptionList != undefined
        ) {
          //检查是否有图片，如果存在图片直接返回-1
          var isContainImg = false;
          var reg = /<img(.*?)>/gi;
          var maxStrCount = 0;
          subChild.ChildOptionList.forEach(function (item) {
            var res = item.Option.trim().match(reg);
            if (res != null && res != undefined && res.length > 0) {
              isContainImg = true;
            }
            var count = getStringLen(item.Option.trim());
            if (count > maxStrCount) maxStrCount = count;
          });
          if (isContainImg) {
            result = -1;
          } else {
            if (typeNo == 'm' && genreId == '15' && maxStrCount < 24) {
              result = 5;
            } else if (typeNo == 'm') {
              result = 1;
            } else if (maxStrCount < 21) {
              result = 4;
            } else if (maxStrCount < 42) {
              result = 2;
            } else {
              result = 1;
            }
          }
        }
        return result;
      };
      //函数：实现中英文字符的精确计算
      var getStringLen = function (Str) {
        var i, len, code;
        if (Str == null || Str == '') return 0;
        len = Str.length;
        for (i = 0; i < Str.length; i++) {
          code = Str.charCodeAt(i);
          if (code > 255) {
            len += 1;
          }
        }
        return len;
      };
      //函数：实现中英文字符的精确计算
      $scope.GetStringLen = function (Str) {
        var i, len, code;
        if (Str == null || Str == '') return 0;
        len = Str.length;
        for (i = 0; i < Str.length; i++) {
          code = Str.charCodeAt(i);
          if (code > 255) {
            len += 1;
          }
        }
        return len;
      };

      //函数：获取序号的宽度
      $scope.GetOrderNumberWidth = function (strObject) {
        var strlength = 0;
        strObject.forEach(function (item) {
          var temp = 0;
          if ((item.SortIndex + '').length == 1) {
            temp = 1;
          } else if ((item.SortIndex + '').length == 2) {
            temp = 2;
          } else {
            temp = 3;
          }
          if (temp >= strlength) {
            strlength = temp;
          }
        });
        return strlength;
      };

      //函数:初始化数字为汉字
      $scope.NumberFormat = function (number) {
        var result = '';
        if (number < 1000) {
          var str1 = ['十', '百'];
          var str2 = [
            '零',
            '一',
            '二',
            '三',
            '四',
            '五',
            '六',
            '七',
            '八',
            '九',
          ];
          var n1 = 0;
          if (number >= 0 && number < 10) result = str2[number];
          else if (number == 10) result = str1[0];
          else if (number > 10 && number < 20) {
            result = str1[0] + str2[number % 10];
          } else if (number >= 20 && number < 100) {
            n1 = number % 10;
            if (n1 == 0) {
              result = str2[number / 10] + str1[0];
            } else {
              result = str2[parseInt(number / 10)] + str1[0] + str2[n1];
            }
          } else if (number >= 100 && number < 1000) {
            n1 = number % 100;
            if (n1 == 0) {
              result = str2[number / 100] + str1[1];
            } else {
              n1 = number % 10;
              if (n1 == 0) {
                number = number / 10;
                result =
                  str2[parseInt(number / 10)] +
                  str1[1] +
                  str2[number % 10] +
                  str1[0];
              } else {
                number = parseInt(number / 10);
                result =
                  str2[parseInt(number / 10)] +
                  str1[1] +
                  str2[number % 10] +
                  str1[0] +
                  str2[n1];
              }
            }
          }
        }
        return result;
      };

      //函数：判断是否要显示试题的问题信息
      $scope.IsShowSubChildAsk = function (str) {
        if (
          str.length > 0 &&
          str != '<BR>' &&
          str != '<br>' &&
          str != '&nbsp;' &&
          str != ' '
        ) {
          return true;
        } else {
          return false;
        }
      };

      //功能：替换答案中的分割符号。
      $scope.ReplaceSubChildAnswer = function (text) {
        var str = text
          .replace(/\$\//g, '或')
          .replace(/\$、/g, '、')
          .replace(/\s\|/g, '和');
        return str;
      };

      //功能：判断是否有答案
      $scope.isHaveAnswer = function (text) {
        if (text == 'undefined' || text == undefined) {
          return '无';
        } else {
          return text;
        }
      };

      //功能：判断是否在body中存在表格及rowspan属性
      $scope.IsAddPageBreakInside = function (str) {
        var flag = false;
        if (str.toLowerCase().indexOf('</table>') > -1) {
          if (str.toLowerCase().indexOf('rowspan') > -1) {
            flag = true;
          }
        }
        return flag;
      };

      //功能判断：是否答案解析所有小题都没有
      $scope.IsAllnoData = function (data) {
        var res = false;
        for (var i = 0; i < data.length; i++) {
          if (data[i].ChildAnalysis != '') {
            res = true;
          }
        }
        return res;
      };
    },
  ]);
</script>

</html>